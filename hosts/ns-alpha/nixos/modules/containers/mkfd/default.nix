{
  pkgs,
  lib,
  config,
  ...
}:
let
  hostname = "mkfd.mattephi.com";
in
{
  sops.secrets."mkfd.env" = {
    format = "dotenv";
    sopsFile = ./.env;
  };
  virtualisation.docker = {
    enable = true;
    autoPrune.enable = true;
  };
  virtualisation.oci-containers.backend = "docker";

  virtualisation.oci-containers.containers."mkfd-mkfd" = {
    image = "tbosk/mkfd:2.0.1";
    environmentFiles = [
      config.sops.secrets."mkfd.env".path
    ];
    volumes = [
      "mkfd-data:/app/configs:rw"
    ];
    ports = [
      "3005:5000/tcp"
    ];
    log-driver = "journald";
    extraOptions = [
      "--network-alias=mkfd"
      "--network=mkfd_default"
    ];
  };
  systemd.services."docker-volume-mkfd-data" = {
    path = [ pkgs.docker ];
    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;
    };
    script = ''
      docker volume inspect mkfd-data || docker volume create mkfd-data
    '';
    partOf = [ "docker-compose-mkfd-root.target" ];
    wantedBy = [ "docker-compose-mkfd-root.target" ];
  };
  systemd.services."docker-mkfd-mkfd" = {
    serviceConfig = {
      Restart = lib.mkOverride 90 "no";
    };
    after = [
      "docker-network-mkfd_default.service"
    ];
    requires = [
      "docker-network-mkfd_default.service"
    ];
    partOf = [
      "docker-compose-mkfd-root.target"
    ];
    wantedBy = [
      "docker-compose-mkfd-root.target"
    ];
  };

  systemd.services."docker-network-mkfd_default" = {
    path = [ pkgs.docker ];
    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;
      ExecStop = "docker network rm -f mkfd_default";
    };
    script = ''
      docker network inspect mkfd_default || docker network create mkfd_default
    '';
    partOf = [ "docker-compose-mkfd-root.target" ];
    wantedBy = [ "docker-compose-mkfd-root.target" ];
  };

  systemd.targets."docker-compose-mkfd-root" = {
    unitConfig = {
      Description = "Root target generated by compose2nix.";
    };
    wantedBy = [ "multi-user.target" ];
  };

  services.caddy.virtualHosts."${hostname}".extraConfig = ''
    reverse_proxy http://127.0.0.1:3005
  '';
}
